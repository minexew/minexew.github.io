---
layout: post
title:  "Welcome to h3dec"
---

Inspired by the fascinating work done on projects such as [StarCraft for Pandora](https://pyra-handheld.com/boards/threads/starcraft.73844/), [pokeruby](https://github.com/pret/pokeruby) and [Devilution](https://github.com/diasurgical/devilution), I set out today to look into the executable of [Heroes of Might and Magic III](https://www.gog.com/game/heroes_of_might_and_magic_3_complete_edition).
The end goal is to derive a C codebase which could be compiled to obtain an executable functionally equivalent to the original. This would facilitate, among others:
 - understanding of the game architecture
 - native porting to other platforms
 - source-level modding (as opposed to in-memory hacks like [HoMM 3 HD](https://sites.google.com/site/heroes3hd/))

As for the tools, I expect to use radare2 heavily, along with the RetDec decompiler.
Of course, a staple of the RE community is IDA Pro along with its C decompiler. I intend to evaluate its capabilities, but due to licensing reasons, the final work-flow should be preferrably based entirely on free software. 
Nevertheless, the entire flow will be heavily data driven (and well-defined), which should allow a choice among multiple tools for each step.

Because everybody loves pictures, let's look at a picture of what *should* work according to my naive, childish imagination:

![image]({{ site.url }}/images/h3dec-flow.svg)

One questions that remains to be answered is whether it is worth it to aim for a bit-perfect reproduction of the original executable. This would of course imply the need to use the original tools. Initial analysis suggests that `MSVC (6.0) Visual Studio 6.0` and `Microsoft Linker (6.0)` were used as the compiler and linker, respectively.

For now, the next step will be to parse and disassemble the entire .text section in a way that allows us to reassemble a bit-exact binary. There doesn't seem to be any readily available tool to do this. Objdump output could probably be regexed, but that's a crappy solution. Radare2 hangs when asked to do "pD" on the entire .text, and RetDec crashes with std::bad_alloc. Welp.

Cool stuff:
 - [radare](https://rada.re/)
 - [yet another radare2 cheatsheet.md](https://gist.github.com/williballenthin/6857590dab3e2a6559d7)
 - [RetDec talk](https://youtu.be/HHFvtt5b6yY)
 - [r2retdec](https://github.com/securisec/r2retdec)
 
